<!doctype html>
<html lang="en">
  <head>
    <meta charset="UTF-8" />
    <meta
      name="viewport"
      content="width=device-width, user-scalable=no, initial-scale=1.0, maximum-scale=1.0, minimum-scale=1.0"
    />
    <title>Stories</title>

    <link rel="stylesheet" href="http://localhost:3000/index.css" />
  </head>

  <body>
    <div class="root">
      <div class="stop-screen">
        <div class="stop-screen__plate"></div>
        <svg
          class="stop-screen__button"
          xmlns="http://www.w3.org/2000/svg"
          viewBox="0 0 24 24"
        >
          <path
            d="M11.0748 7.50835C9.74622 6.72395 8.25 7.79065 8.25 9.21316V14.7868C8.25 16.2093 9.74622 17.276 11.0748 16.4916L15.795 13.7048C17.0683 12.953 17.0683 11.047 15.795 10.2952L11.0748 7.50835ZM9.75 9.21316C9.75 9.01468 9.84615 8.87585 9.95947 8.80498C10.0691 8.73641 10.1919 8.72898 10.3122 8.80003L15.0324 11.5869C15.165 11.6652 15.25 11.8148 15.25 12C15.25 12.1852 15.165 12.3348 15.0324 12.4131L10.3122 15.2C10.1919 15.271 10.0691 15.2636 9.95947 15.195C9.84615 15.1242 9.75 14.9853 9.75 14.7868V9.21316Z"
          />
          <path
            d="M12 1.25C6.06294 1.25 1.25 6.06294 1.25 12C1.25 17.9371 6.06294 22.75 12 22.75C17.9371 22.75 22.75 17.9371 22.75 12C22.75 6.06294 17.9371 1.25 12 1.25ZM2.75 12C2.75 6.89137 6.89137 2.75 12 2.75C17.1086 2.75 21.25 6.89137 21.25 12C21.25 17.1086 17.1086 21.25 12 21.25C6.89137 21.25 2.75 17.1086 2.75 12Z"
          />
        </svg>
      </div>
      <div class="progress">
        <!-- script inserted progress-bars -->
      </div>
      <div class="stories">
        <!-- script inserted stories -->
      </div>
      <button class="show-reactions-btn">üëç</button>
      <div class="reactions">
        <button class="reaction">üëç</button>
        <button class="reaction">‚ù§Ô∏è</button>
        <button class="reaction">üòÇ</button>
        <button class="reaction">üòÆ</button>
        <button class="reaction">üò¢</button>
      </div>
      <div class="overlay"></div>
      <div class="controls">
        <div class="controls__buttons">
          <button
            id="prev-btn"
            onclick="prev()"
            class="button"
            aria-label="–ü—Ä–µ–¥—ã–¥—É—â–∏–π —Å–ª–∞–π–¥"
          >
            <svg
              xmlns="http://www.w3.org/2000/svg"
              width="24"
              height="24"
              viewBox="0 0 24 24"
            >
              <path
                d="M15.41 7.41L14 6l-6 6 6 6 1.41-1.41L9.83 12l5.58-5.59z"
              />
            </svg>
          </button>
          <button
            id="next-btn"
            onclick="next()"
            class="button button_next"
            aria-label="–°–ª–µ–¥—É—é—â–∏–π —Å–ª–∞–π–¥"
          >
            <svg
              xmlns="http://www.w3.org/2000/svg"
              width="24"
              height="24"
              viewBox="0 0 24 24"
            >
              <path
                d="M15.41 7.41L14 6l-6 6 6 6 1.41-1.41L9.83 12l5.58-5.59z"
              />
            </svg>
          </button>
        </div>
      </div>
    </div>

    <script>
      const videosSrc = [
        "http://localhost:3000/assets/1.mp4",
        "http://localhost:3000/assets/2.mp4",
        "http://localhost:3000/assets/3.mp4",
        "http://localhost:3000/assets/4.mp4",
        "http://localhost:3000/assets/5.mp4",
      ];

      // DOM —ç–ª–µ–º–µ–Ω—Ç—ã
      const slider = document.querySelector(".stories");
      const progressContainer = document.querySelector(".progress");
      const stopScreen = document.querySelector(".stop-screen");
      const showReactionsBtn = document.querySelector(".show-reactions-btn");
      const reactionsPanel = document.querySelector(".reactions");
      const overlay = document.querySelector(".overlay");
      const reactionButtons = document.querySelectorAll(".reaction");
      const prevBtn = document.getElementById("prev-btn");
      const nextBtn = document.getElementById("next-btn");

      // –°–æ—Å—Ç–æ—è–Ω–∏–µ –ø—Ä–∏–ª–æ–∂–µ–Ω–∏—è
      let currentStoryIndex = 0;
      let isPlaying = false;
      let progressAnimationId = null;
      let stories = [];
      let reactionsVisible = false;
      let timeUpdateHandlers = new Map(); // –î–ª—è —Ö—Ä–∞–Ω–µ–Ω–∏—è –æ–±—Ä–∞–±–æ—Ç—á–∏–∫–æ–≤ timeupdate
      let wasPlayingBeforeReactions = false; // –°–æ—Ö—Ä–∞–Ω—è–µ–º —Å–æ—Å—Ç–æ—è–Ω–∏–µ –≤–æ—Å–ø—Ä–æ–∏–∑–≤–µ–¥–µ–Ω–∏—è –ø–µ—Ä–µ–¥ –æ—Ç–∫—Ä—ã—Ç–∏–µ–º —Ä–µ–∞–∫—Ü–∏–π

      // –°–æ—Å—Ç–æ—è–Ω–∏–µ –¥–ª—è —Å–≤–∞–π–ø–æ–≤
      let touchStartX = 0;
      let touchStartY = 0;
      let touchEndX = 0;
      let touchEndY = 0;
      let isSwipeActive = false;
      let isSwiping = false;
      let swipeDirection = null; // 'left' –∏–ª–∏ 'right'
      let resetPositionTimeout = null; // –¢–∞–π–º–µ—Ä –¥–ª—è —Å–±—Ä–æ—Å–∞ –ø–æ–∑–∏—Ü–∏–π
      const SWIPE_THRESHOLD = 50; // –ú–∏–Ω–∏–º–∞–ª—å–Ω–æ–µ —Ä–∞—Å—Å—Ç–æ—è–Ω–∏–µ –¥–ª—è –æ–ø—Ä–µ–¥–µ–ª–µ–Ω–∏—è —Å–≤–∞–π–ø–∞
      const SWIPE_VERTICAL_THRESHOLD = 100; // –ú–∞–∫—Å–∏–º–∞–ª—å–Ω–æ–µ –≤–µ—Ä—Ç–∏–∫–∞–ª—å–Ω–æ–µ –æ—Ç–∫–ª–æ–Ω–µ–Ω–∏–µ
      const SWIPE_ANIMATION_DURATION = 300; // –î–ª–∏—Ç–µ–ª—å–Ω–æ—Å—Ç—å –∞–Ω–∏–º–∞—Ü–∏–∏ –≤ –º–∏–ª–ª–∏—Å–µ–∫—É–Ω–¥–∞—Ö

      // –ò–Ω–∏—Ü–∏–∞–ª–∏–∑–∞—Ü–∏—è —Å—Ç–æ—Ä–∏–∑
      function initStory(id, src) {
        // –î–ª—è –ø–µ—Ä–≤–æ–≥–æ –≤–∏–¥–µ–æ –¥–æ–±–∞–≤–ª—è–µ–º autoplay –¥–ª—è –∞–≤—Ç–æ–º–∞—Ç–∏—á–µ—Å–∫–æ–≥–æ –∑–∞–ø—É—Å–∫–∞
        const autoplayAttr = id === 0 ? "autoplay" : "";
        slider.insertAdjacentHTML(
          "beforeend",
          `<div class="stories__story" data-story-id="${id}">
                <video id="video-${id}" class="stories__video" src="${src}" loop="false" playsinline muted ${autoplayAttr}></video>
            </div>`,
        );

        progressContainer.insertAdjacentHTML(
          "beforeend",
          `<span class="progress__bar" data-story-index="${id}">
                <span id="progress-${id}" class="progress__bar-value"></span>
            </span>`,
        );

        return getStory(id);
      }

      function getStory(id) {
        const storyElement = document.querySelector(`[data-story-id="${id}"]`);
        const video = document.getElementById(`video-${id}`);
        const progressBar = document.getElementById(`progress-${id}`);
        const progressBarContainer = document.querySelector(
          `.progress__bar[data-story-index="${id}"]`,
        );
        return {
          id,
          element: storyElement,
          video,
          progressBar,
          progressBarContainer,
        };
      }

      // –ò–Ω–∏—Ü–∏–∞–ª–∏–∑–∞—Ü–∏—è –≤—Å–µ—Ö —Å—Ç–æ—Ä–∏–∑
      function initStories() {
        videosSrc.forEach((src, index) => {
          const story = initStory(index, src);
          stories.push(story);

          // –ù–∞—Å—Ç—Ä–æ–π–∫–∞ –≤–∏–¥–µ–æ
          if (index === 0) {
            // –î–ª—è –ø–µ—Ä–≤–æ–≥–æ –≤–∏–¥–µ–æ –Ω–∞—Å—Ç—Ä–∞–∏–≤–∞–µ–º –∞–≤—Ç–æ–∑–∞–ø—É—Å–∫
            const tryPlay = () => {
              // –£–±–∏—Ä–∞–µ–º muted –∏ –ø—ã—Ç–∞–µ–º—Å—è –∑–∞–ø—É—Å—Ç–∏—Ç—å
              story.video.muted = false;
              story.video
                .play()
                .then(() => {
                  isPlaying = true;
                  updateStopScreen();
                  startProgressAnimation();
                })
                .catch((err) => {
                  // –ï—Å–ª–∏ –∞–≤—Ç–æ–∑–∞–ø—É—Å–∫ –∑–∞–±–ª–æ–∫–∏—Ä–æ–≤–∞–Ω –±—Ä–∞—É–∑–µ—Ä–æ–º, –æ—Å—Ç–∞–≤–ª—è–µ–º muted –∏ –∑–∞–ø—É—Å–∫–∞–µ–º
                  console.warn("Autoplay blocked, playing muted:", err);
                  story.video.muted = true;
                  story.video
                    .play()
                    .then(() => {
                      isPlaying = true;
                      updateStopScreen();
                      startProgressAnimation();
                      // –ü—ã—Ç–∞–µ–º—Å—è –≤–∫–ª—é—á–∏—Ç—å –∑–≤—É–∫ –ø–æ—Å–ª–µ –ø–µ—Ä–≤–æ–≥–æ –≤–∑–∞–∏–º–æ–¥–µ–π—Å—Ç–≤–∏—è –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—è
                      document.addEventListener(
                        "click",
                        () => {
                          if (story.video.muted) {
                            story.video.muted = false;
                          }
                        },
                        { once: true },
                      );
                    })
                    .catch((err2) => {
                      console.error("Error playing video:", err2);
                    });
                });
            };

            // –ü—ã—Ç–∞–µ–º—Å—è –∑–∞–ø—É—Å—Ç–∏—Ç—å —Å—Ä–∞–∑—É, –µ—Å–ª–∏ –º–µ—Ç–∞–¥–∞–Ω–Ω—ã–µ —É–∂–µ –∑–∞–≥—Ä—É–∂–µ–Ω—ã
            if (story.video.readyState >= 1) {
              tryPlay();
            } else {
              // –ò–Ω–∞—á–µ –∂–¥–µ–º –∑–∞–≥—Ä—É–∑–∫–∏ –º–µ—Ç–∞–¥–∞–Ω–Ω—ã—Ö –∏–ª–∏ canplay (—á—Ç–æ –ø—Ä–æ–∏–∑–æ–π–¥–µ—Ç —Ä–∞–Ω—å—à–µ)
              let played = false;
              const playOnce = () => {
                if (!played) {
                  played = true;
                  tryPlay();
                }
              };
              story.video.addEventListener("loadedmetadata", playOnce, {
                once: true,
              });
              story.video.addEventListener("canplay", playOnce, { once: true });
            }
          }

          story.video.addEventListener("ended", () => {
            if (index === currentStoryIndex) {
              next();
            }
          });

          // –ü—Ä–µ–¥–∑–∞–≥—Ä—É–∑–∫–∞ —Å–ª–µ–¥—É—é—â–µ–≥–æ –≤–∏–¥–µ–æ
          if (index < videosSrc.length - 1) {
            story.video.preload = "auto";
          }

          // –û–±—Ä–∞–±–æ—Ç—á–∏–∫ –∫–ª–∏–∫–∞ –ø–æ –≤–∏–¥–µ–æ –¥–ª—è –ø–∞—É–∑—ã/–≤–æ—Å–ø—Ä–æ–∏–∑–≤–µ–¥–µ–Ω–∏—è
          story.video.addEventListener("click", (e) => {
            e.stopPropagation();
            // –ù–µ –æ–±—Ä–∞–±–∞—Ç—ã–≤–∞–µ–º –∫–ª–∏–∫–∏, –µ—Å–ª–∏ –æ—Ç–∫—Ä—ã—Ç–∞ –ø–∞–Ω–µ–ª—å —Ä–µ–∞–∫—Ü–∏–π
            if (!reactionsVisible) {
              togglePlay();
            }
          });

          // –û–±—Ä–∞–±–æ—Ç—á–∏–∫–∏ touch-—Å–æ–±—ã—Ç–∏–π –¥–ª—è —Å–≤–∞–π–ø–æ–≤ –Ω–∞ –≤–∏–¥–µ–æ
          story.video.addEventListener("touchstart", handleTouchStart, {
            passive: false,
          });
          story.video.addEventListener("touchmove", handleTouchMove, {
            passive: false,
          });
          story.video.addEventListener("touchend", handleTouchEnd, {
            passive: true,
          });
          story.video.addEventListener("touchcancel", () => {
            if (isSwiping) {
              resetStoryPositions();
              isSwiping = false;
            }
            isSwipeActive = false;
            swipeDirection = null;
          });
        });

        // –ü–æ–∫–∞–∑—ã–≤–∞–µ–º –ø–µ—Ä–≤—ã–π —Å–ª–∞–π–¥
        showStory(0);

        // –î–æ–±–∞–≤–ª—è–µ–º –æ–±—Ä–∞–±–æ—Ç—á–∏–∫–∏ –∫–ª–∏–∫–æ–≤ –Ω–∞ –ø—Ä–æ–≥—Ä–µ—Å—Å-–±–∞—Ä—ã
        stories.forEach((story, index) => {
          if (story.progressBarContainer) {
            story.progressBarContainer.addEventListener("click", (e) => {
              e.stopPropagation();
              goToStory(index);
            });
            // –î–µ–ª–∞–µ–º –ø—Ä–æ–≥—Ä–µ—Å—Å-–±–∞—Ä –∫–ª–∏–∫–∞–±–µ–ª—å–Ω—ã–º
            story.progressBarContainer.style.cursor = "pointer";
          }
        });
      }

      // –ü–µ—Ä–µ–∫–ª—é—á–µ–Ω–∏–µ –Ω–∞ —Å–ª–∞–π–¥ –ø–æ –∏–Ω–¥–µ–∫—Å—É
      function goToStory(index) {
        if (index < 0 || index >= stories.length || index === currentStoryIndex) {
          return;
        }

        const currentVideo = stories[currentStoryIndex].video;

        // –£–¥–∞–ª—è–µ–º –æ–±—Ä–∞–±–æ—Ç—á–∏–∫ timeupdate –¥–ª—è —Ç–µ–∫—É—â–µ–≥–æ –≤–∏–¥–µ–æ
        if (timeUpdateHandlers.has(currentVideo)) {
          const handler = timeUpdateHandlers.get(currentVideo);
          currentVideo.removeEventListener("timeupdate", handler);
          timeUpdateHandlers.delete(currentVideo);
        }

        currentVideo.pause();
        currentVideo.currentTime = 0;

        const targetVideo = stories[index].video;

        showStory(index);
        targetVideo.currentTime = 0;

        // –§—É–Ω–∫—Ü–∏—è –¥–ª—è –∑–∞–ø—É—Å–∫–∞ —Ü–µ–ª–µ–≤–æ–≥–æ –≤–∏–¥–µ–æ
        const playTargetVideo = () => {
          // –ü—ã—Ç–∞–µ–º—Å—è –∑–∞–ø—É—Å—Ç–∏—Ç—å —Å–æ –∑–≤—É–∫–æ–º
          targetVideo.muted = false;
          targetVideo
            .play()
            .then(() => {
              isPlaying = true;
              updateStopScreen();
              startProgressAnimation();
            })
            .catch((err) => {
              // –ï—Å–ª–∏ –∞–≤—Ç–æ–∑–∞–ø—É—Å–∫ –∑–∞–±–ª–æ–∫–∏—Ä–æ–≤–∞–Ω, –∑–∞–ø—É—Å–∫–∞–µ–º –±–µ–∑ –∑–≤—É–∫–∞
              console.warn("Autoplay blocked for target video, playing muted:", err);
              targetVideo.muted = true;
              targetVideo
                .play()
                .then(() => {
                  isPlaying = true;
                  updateStopScreen();
                  startProgressAnimation();
                  // –í–∫–ª—é—á–∞–µ–º –∑–≤—É–∫ –ø–æ—Å–ª–µ –ø–µ—Ä–≤–æ–≥–æ –≤–∑–∞–∏–º–æ–¥–µ–π—Å—Ç–≤–∏—è
                  const enableSound = () => {
                    if (targetVideo.muted) {
                      targetVideo.muted = false;
                    }
                    document.removeEventListener("click", enableSound);
                  };
                  document.addEventListener("click", enableSound, { once: true });
                })
                .catch((err2) => {
                  console.error("Error playing target video:", err2);
                });
            });
        };

        // –ñ–¥–µ–º –≥–æ—Ç–æ–≤–Ω–æ—Å—Ç–∏ –≤–∏–¥–µ–æ –ø–µ—Ä–µ–¥ –≤–æ—Å–ø—Ä–æ–∏–∑–≤–µ–¥–µ–Ω–∏–µ–º
        if (targetVideo.readyState >= 2) {
          playTargetVideo();
        } else {
          // –ó–∞—â–∏—Ç–∞ –æ—Ç –¥–≤–æ–π–Ω–æ–≥–æ –∑–∞–ø—É—Å–∫–∞
          let played = false;
          const playOnce = () => {
            if (!played) {
              played = true;
              playTargetVideo();
            }
          };
          targetVideo.addEventListener("loadeddata", playOnce, {
            once: true,
          });
          targetVideo.addEventListener("canplay", playOnce, { once: true });
        }
      }

      // –ü–æ–∫–∞–∑–∞—Ç—å –∫–æ–Ω–∫—Ä–µ—Ç–Ω—ã–π —Å–ª–∞–π–¥
      function showStory(index, offsetX = 0) {
        if (index < 0 || index >= stories.length) return;

        const containerWidth = slider.offsetWidth || 450;

        // –ü–æ–∫–∞–∑—ã–≤–∞–µ–º –≤—Å–µ —Å–ª–∞–π–¥—ã —Å –ø—Ä–∞–≤–∏–ª—å–Ω—ã–º –ø–æ–∑–∏—Ü–∏–æ–Ω–∏—Ä–æ–≤–∞–Ω–∏–µ–º
        stories.forEach((story, i) => {
          story.element.style.display = "flex";
          const offset = (i - index) * containerWidth + offsetX;
          story.element.style.transform = `translateX(${offset}px)`;
          story.element.classList.remove("swiping");
        });

        // –°–±—Ä–∞—Å—ã–≤–∞–µ–º –ø—Ä–æ–≥—Ä–µ—Å—Å-–±–∞—Ä—ã
        stories.forEach((story, i) => {
          if (i < index) {
            story.progressBar.style.transform = "scaleX(1)";
          } else if (i === index) {
            story.progressBar.style.transform = "scaleX(0)";
          } else {
            story.progressBar.style.transform = "scaleX(0)";
          }
        });

        currentStoryIndex = index;
        updateControlsState();

        // –ï—Å–ª–∏ offsetX = 0 (–æ–±—ã—á–Ω–æ–µ –ø–µ—Ä–µ–∫–ª—é—á–µ–Ω–∏–µ), —Å–±—Ä–∞—Å—ã–≤–∞–µ–º –ø–æ–∑–∏—Ü–∏–∏ –ø–æ—Å–ª–µ –∞–Ω–∏–º–∞—Ü–∏–∏
        if (offsetX === 0) {
          // –û—á–∏—â–∞–µ–º –ø—Ä–µ–¥—ã–¥—É—â–∏–π —Ç–∞–π–º–µ—Ä, –µ—Å–ª–∏ –æ–Ω –µ—Å—Ç—å
          if (resetPositionTimeout) {
            clearTimeout(resetPositionTimeout);
          }
          resetPositionTimeout = setTimeout(() => {
            resetStoryPositions();
            resetPositionTimeout = null;
          }, SWIPE_ANIMATION_DURATION);
        }
      }

      // –°–±—Ä–æ—Å –ø–æ–∑–∏—Ü–∏–π —Å–ª–∞–π–¥–æ–≤ –ø–æ—Å–ª–µ –∑–∞–≤–µ—Ä—à–µ–Ω–∏—è –∞–Ω–∏–º–∞—Ü–∏–∏
      function resetStoryPositions() {
        stories.forEach((story, i) => {
          if (i === currentStoryIndex) {
            story.element.style.display = "flex";
            story.element.style.transform = "translateX(0)";
          } else {
            story.element.style.display = "none";
          }
          story.element.classList.remove("swiping");
        });
      }

      // –û–±–Ω–æ–≤–ª–µ–Ω–∏–µ —Å–æ—Å—Ç–æ—è–Ω–∏—è –∫–æ–Ω—Ç—Ä–æ–ª–æ–≤
      function updateControlsState() {
        // –û–±–Ω–æ–≤–ª—è–µ–º —Å–æ—Å—Ç–æ—è–Ω–∏–µ –∫–Ω–æ–ø–æ–∫ prev/next
        if (prevBtn) {
          prevBtn.disabled = currentStoryIndex === 0;
          prevBtn.classList.toggle("button_disabled", currentStoryIndex === 0);
        }
        if (nextBtn) {
          nextBtn.disabled = currentStoryIndex === stories.length - 1;
          nextBtn.classList.toggle(
            "button_disabled",
            currentStoryIndex === stories.length - 1
          );
        }
      }

      // –ü–µ—Ä–µ–∫–ª—é—á–µ–Ω–∏–µ –Ω–∞ —Å–ª–µ–¥—É—é—â–∏–π —Å–ª–∞–π–¥
      function next() {
        if (currentStoryIndex < stories.length - 1) {
          const currentVideo = stories[currentStoryIndex].video;
          const nextIndex = currentStoryIndex + 1;
          const nextVideo = stories[nextIndex].video;

          // –£–¥–∞–ª—è–µ–º –æ–±—Ä–∞–±–æ—Ç—á–∏–∫ timeupdate –¥–ª—è —Ç–µ–∫—É—â–µ–≥–æ –≤–∏–¥–µ–æ
          if (timeUpdateHandlers.has(currentVideo)) {
            const handler = timeUpdateHandlers.get(currentVideo);
            currentVideo.removeEventListener("timeupdate", handler);
            timeUpdateHandlers.delete(currentVideo);
          }

          currentVideo.pause();
          currentVideo.currentTime = 0;

          // –û—á–∏—â–∞–µ–º —Ç–∞–π–º–µ—Ä —Å–±—Ä–æ—Å–∞ –ø–æ–∑–∏—Ü–∏–π –ø–µ—Ä–µ–¥ –ø–µ—Ä–µ–∫–ª—é—á–µ–Ω–∏–µ–º
          if (resetPositionTimeout) {
            clearTimeout(resetPositionTimeout);
            resetPositionTimeout = null;
          }

          // –°–±—Ä–∞—Å—ã–≤–∞–µ–º –ø–æ–∑–∏—Ü–∏–∏ –ø–µ—Ä–µ–¥ –ø–µ—Ä–µ–∫–ª—é—á–µ–Ω–∏–µ–º –¥–ª—è –∫–æ—Ä—Ä–µ–∫—Ç–Ω–æ–π –∞–Ω–∏–º–∞—Ü–∏–∏
          const containerWidth = slider.offsetWidth || 450;
          stories.forEach((story, i) => {
            story.element.style.display = "flex";
            if (i === currentStoryIndex) {
              story.element.style.transform = "translateX(0)";
            } else if (i === nextIndex) {
              story.element.style.transform = `translateX(${containerWidth}px)`;
            } else {
              const offset = (i - currentStoryIndex) * containerWidth;
              story.element.style.transform = `translateX(${offset}px)`;
            }
            story.element.classList.remove("swiping");
          });

          // –ù–µ–±–æ–ª—å—à–∞—è –∑–∞–¥–µ—Ä–∂–∫–∞ –¥–ª—è –Ω–∞—á–∞–ª–∞ –∞–Ω–∏–º–∞—Ü–∏–∏
          requestAnimationFrame(() => {
            currentStoryIndex = nextIndex;
            const targetVideo = stories[currentStoryIndex].video;
            showStory(currentStoryIndex);
            targetVideo.currentTime = 0;

            // –§—É–Ω–∫—Ü–∏—è –¥–ª—è –∑–∞–ø—É—Å–∫–∞ —Å–ª–µ–¥—É—é—â–µ–≥–æ –≤–∏–¥–µ–æ
            const playNextVideo = () => {
              // –ü—ã—Ç–∞–µ–º—Å—è –∑–∞–ø—É—Å—Ç–∏—Ç—å —Å–æ –∑–≤—É–∫–æ–º
              targetVideo.muted = false;
              targetVideo
                .play()
                .then(() => {
                  isPlaying = true;
                  updateStopScreen();
                  startProgressAnimation();
                })
                .catch((err) => {
                  // –ï—Å–ª–∏ –∞–≤—Ç–æ–∑–∞–ø—É—Å–∫ –∑–∞–±–ª–æ–∫–∏—Ä–æ–≤–∞–Ω, –∑–∞–ø—É—Å–∫–∞–µ–º –±–µ–∑ –∑–≤—É–∫–∞
                  console.warn("Autoplay blocked for next video, playing muted:", err);
                  targetVideo.muted = true;
                  targetVideo
                    .play()
                    .then(() => {
                      isPlaying = true;
                      updateStopScreen();
                      startProgressAnimation();
                      // –í–∫–ª—é—á–∞–µ–º –∑–≤—É–∫ –ø–æ—Å–ª–µ –ø–µ—Ä–≤–æ–≥–æ –≤–∑–∞–∏–º–æ–¥–µ–π—Å—Ç–≤–∏—è
                      const enableSound = () => {
                        if (targetVideo.muted) {
                          targetVideo.muted = false;
                        }
                        document.removeEventListener("click", enableSound);
                      };
                      document.addEventListener("click", enableSound, { once: true });
                    })
                    .catch((err2) => {
                      console.error("Error playing next video:", err2);
                    });
                });
            };

            // –ñ–¥–µ–º –≥–æ—Ç–æ–≤–Ω–æ—Å—Ç–∏ –≤–∏–¥–µ–æ –ø–µ—Ä–µ–¥ –≤–æ—Å–ø—Ä–æ–∏–∑–≤–µ–¥–µ–Ω–∏–µ–º
            if (targetVideo.readyState >= 2) {
              playNextVideo();
            } else {
              // –ó–∞—â–∏—Ç–∞ –æ—Ç –¥–≤–æ–π–Ω–æ–≥–æ –∑–∞–ø—É—Å–∫–∞
              let played = false;
              const playOnce = () => {
                if (!played) {
                  played = true;
                  playNextVideo();
                }
              };
              targetVideo.addEventListener("loadeddata", playOnce, {
                once: true,
              });
              // –¢–∞–∫–∂–µ –ø—Ä–æ–±—É–µ–º –∑–∞–ø—É—Å—Ç–∏—Ç—å –ø—Ä–∏ canplay
              targetVideo.addEventListener("canplay", playOnce, {
                once: true,
              });
            }
          });
        } else {
          // –ü–æ—Å–ª–µ–¥–Ω–∏–π —Å–ª–∞–π–¥ - –æ—Å—Ç–∞–Ω–∞–≤–ª–∏–≤–∞–µ–º –ø—Ä–æ–≥—Ä–µ—Å—Å
          const currentVideo = stories[currentStoryIndex].video;
          if (timeUpdateHandlers.has(currentVideo)) {
            const handler = timeUpdateHandlers.get(currentVideo);
            currentVideo.removeEventListener("timeupdate", handler);
            timeUpdateHandlers.delete(currentVideo);
          }
          stopProgressAnimation();
          isPlaying = false;
          updateStopScreen();
        }
      }

      // –ü–µ—Ä–µ–∫–ª—é—á–µ–Ω–∏–µ –Ω–∞ –ø—Ä–µ–¥—ã–¥—É—â–∏–π —Å–ª–∞–π–¥
      function prev() {
        if (currentStoryIndex > 0) {
          const currentVideo = stories[currentStoryIndex].video;

          // –£–¥–∞–ª—è–µ–º –æ–±—Ä–∞–±–æ—Ç—á–∏–∫ timeupdate –¥–ª—è —Ç–µ–∫—É—â–µ–≥–æ –≤–∏–¥–µ–æ
          if (timeUpdateHandlers.has(currentVideo)) {
            const handler = timeUpdateHandlers.get(currentVideo);
            currentVideo.removeEventListener("timeupdate", handler);
            timeUpdateHandlers.delete(currentVideo);
          }

          currentVideo.pause();
          currentVideo.currentTime = 0;

          // –û—á–∏—â–∞–µ–º —Ç–∞–π–º–µ—Ä —Å–±—Ä–æ—Å–∞ –ø–æ–∑–∏—Ü–∏–π –ø–µ—Ä–µ–¥ –ø–µ—Ä–µ–∫–ª—é—á–µ–Ω–∏–µ–º
          if (resetPositionTimeout) {
            clearTimeout(resetPositionTimeout);
            resetPositionTimeout = null;
          }

          // –°–±—Ä–∞—Å—ã–≤–∞–µ–º –ø–æ–∑–∏—Ü–∏–∏ –ø–µ—Ä–µ–¥ –ø–µ—Ä–µ–∫–ª—é—á–µ–Ω–∏–µ–º –¥–ª—è –∫–æ—Ä—Ä–µ–∫—Ç–Ω–æ–π –∞–Ω–∏–º–∞—Ü–∏–∏
          const containerWidth = slider.offsetWidth || 450;
          const prevIndex = currentStoryIndex - 1;
          stories.forEach((story, i) => {
            story.element.style.display = "flex";
            if (i === currentStoryIndex) {
              story.element.style.transform = "translateX(0)";
            } else if (i === prevIndex) {
              story.element.style.transform = `translateX(${-containerWidth}px)`;
            } else {
              const offset = (i - currentStoryIndex) * containerWidth;
              story.element.style.transform = `translateX(${offset}px)`;
            }
            story.element.classList.remove("swiping");
          });

          // –ù–µ–±–æ–ª—å—à–∞—è –∑–∞–¥–µ—Ä–∂–∫–∞ –¥–ª—è –Ω–∞—á–∞–ª–∞ –∞–Ω–∏–º–∞—Ü–∏–∏
          requestAnimationFrame(() => {
            currentStoryIndex = prevIndex;
            const prevVideo = stories[currentStoryIndex].video;
            showStory(currentStoryIndex);
            prevVideo.currentTime = 0;
          });

          // –§—É–Ω–∫—Ü–∏—è –¥–ª—è –∑–∞–ø—É—Å–∫–∞ –ø—Ä–µ–¥—ã–¥—É—â–µ–≥–æ –≤–∏–¥–µ–æ
          const playPrevVideo = () => {
            // –ü—ã—Ç–∞–µ–º—Å—è –∑–∞–ø—É—Å—Ç–∏—Ç—å —Å–æ –∑–≤—É–∫–æ–º
            prevVideo.muted = false;
            prevVideo
              .play()
              .then(() => {
                isPlaying = true;
                updateStopScreen();
                startProgressAnimation();
              })
              .catch((err) => {
                // –ï—Å–ª–∏ –∞–≤—Ç–æ–∑–∞–ø—É—Å–∫ –∑–∞–±–ª–æ–∫–∏—Ä–æ–≤–∞–Ω, –∑–∞–ø—É—Å–∫–∞–µ–º –±–µ–∑ –∑–≤—É–∫–∞
                console.warn("Autoplay blocked for prev video, playing muted:", err);
                prevVideo.muted = true;
                prevVideo
                  .play()
                  .then(() => {
                    isPlaying = true;
                    updateStopScreen();
                    startProgressAnimation();
                    // –í–∫–ª—é—á–∞–µ–º –∑–≤—É–∫ –ø–æ—Å–ª–µ –ø–µ—Ä–≤–æ–≥–æ –≤–∑–∞–∏–º–æ–¥–µ–π—Å—Ç–≤–∏—è
                    const enableSound = () => {
                      if (prevVideo.muted) {
                        prevVideo.muted = false;
                      }
                      document.removeEventListener("click", enableSound);
                    };
                    document.addEventListener("click", enableSound, { once: true });
                  })
                  .catch((err2) => {
                    console.error("Error playing prev video:", err2);
                  });
              });
          };

          // –ñ–¥–µ–º –≥–æ—Ç–æ–≤–Ω–æ—Å—Ç–∏ –≤–∏–¥–µ–æ –ø–µ—Ä–µ–¥ –≤–æ—Å–ø—Ä–æ–∏–∑–≤–µ–¥–µ–Ω–∏–µ–º
          if (prevVideo.readyState >= 2) {
            playPrevVideo();
          } else {
            // –ó–∞—â–∏—Ç–∞ –æ—Ç –¥–≤–æ–π–Ω–æ–≥–æ –∑–∞–ø—É—Å–∫–∞
            let played = false;
            const playOnce = () => {
              if (!played) {
                played = true;
                playPrevVideo();
              }
            };
            prevVideo.addEventListener("loadeddata", playOnce, {
              once: true,
            });
            // –¢–∞–∫–∂–µ –ø—Ä–æ–±—É–µ–º –∑–∞–ø—É—Å—Ç–∏—Ç—å –ø—Ä–∏ canplay
            prevVideo.addEventListener("canplay", playOnce, {
              once: true,
            });
          }
        }
      }

      // –ü–∞—É–∑–∞/–≤–æ—Å–ø—Ä–æ–∏–∑–≤–µ–¥–µ–Ω–∏–µ
      function togglePlay() {
        if (reactionsVisible) {
          // –ï—Å–ª–∏ –æ—Ç–∫—Ä—ã—Ç–∞ –ø–∞–Ω–µ–ª—å —Ä–µ–∞–∫—Ü–∏–π, –∑–∞–∫—Ä—ã–≤–∞–µ–º –µ—ë
          hideReactions();
          return;
        }

        const currentVideo = stories[currentStoryIndex].video;

        if (isPlaying) {
          // –°—Ç–∞–≤–∏–º –Ω–∞ –ø–∞—É–∑—É
          currentVideo.pause();
          isPlaying = false;
          stopProgressAnimation();
          updateStopScreen();
        } else {
          // –í–æ–∑–æ–±–Ω–æ–≤–ª—è–µ–º –≤–æ—Å–ø—Ä–æ–∏–∑–≤–µ–¥–µ–Ω–∏–µ
          currentVideo
            .play()
            .then(() => {
              isPlaying = true;
              updateStopScreen();
              startProgressAnimation();
            })
            .catch((err) => {
              console.error("Error playing video:", err);
              // –ï—Å–ª–∏ –Ω–µ —É–¥–∞–ª–æ—Å—å –∑–∞–ø—É—Å—Ç–∏—Ç—å, –æ–±–Ω–æ–≤–ª—è–µ–º —ç–∫—Ä–∞–Ω –ø–∞—É–∑—ã
              updateStopScreen();
            });
        }
      }

      // –û–±–Ω–æ–≤–ª–µ–Ω–∏–µ —ç–∫—Ä–∞–Ω–∞ –ø–∞—É–∑—ã
      function updateStopScreen() {
        // –≠–∫—Ä–∞–Ω –ø–∞—É–∑—ã –≤–∏–¥–µ–Ω —Ç–æ–ª—å–∫–æ –∫–æ–≥–¥–∞ –≤–∏–¥–µ–æ –ù–ï –∏–≥—Ä–∞–µ—Ç –∏ –ø–∞–Ω–µ–ª—å —Ä–µ–∞–∫—Ü–∏–π –∑–∞–∫—Ä—ã—Ç–∞
        if (!isPlaying && !reactionsVisible) {
          stopScreen.classList.remove("stop-screen_playing");
        } else {
          stopScreen.classList.add("stop-screen_playing");
        }
      }

      // –ê–Ω–∏–º–∞—Ü–∏—è –ø—Ä–æ–≥—Ä–µ—Å—Å-–±–∞—Ä–∞
      function startProgressAnimation() {
        stopProgressAnimation();

        const currentStory = stories[currentStoryIndex];
        const video = currentStory.video;
        const progressBar = currentStory.progressBar;

        if (!video || !progressBar || !video.duration) return;

        // –£–¥–∞–ª—è–µ–º —Å—Ç–∞—Ä—ã–π –æ–±—Ä–∞–±–æ—Ç—á–∏–∫, –µ—Å–ª–∏ –µ—Å—Ç—å
        if (timeUpdateHandlers.has(video)) {
          const oldHandler = timeUpdateHandlers.get(video);
          video.removeEventListener("timeupdate", oldHandler);
        }

        // –§—É–Ω–∫—Ü–∏—è –æ–±–Ω–æ–≤–ª–µ–Ω–∏—è –ø—Ä–æ–≥—Ä–µ—Å—Å–∞ –Ω–∞ –æ—Å–Ω–æ–≤–µ –≤—Ä–µ–º–µ–Ω–∏ –≤–∏–¥–µ–æ
        function updateProgress() {
          if (!isPlaying || reactionsVisible || video.paused) {
            return;
          }

          const currentTime = video.currentTime;
          const duration = video.duration;

          if (duration && duration > 0) {
            const progress = Math.min(currentTime / duration, 1);
            progressBar.style.transform = `scaleX(${progress})`;
            progressBar.style.transition = "none";
          }
        }

        // –°–æ—Ö—Ä–∞–Ω—è–µ–º –æ–±—Ä–∞–±–æ—Ç—á–∏–∫ –¥–ª—è –ø–æ—Å–ª–µ–¥—É—é—â–µ–≥–æ —É–¥–∞–ª–µ–Ω–∏—è
        timeUpdateHandlers.set(video, updateProgress);
        video.addEventListener("timeupdate", updateProgress);

        // –ù–∞—á–∞–ª—å–Ω–æ–µ –æ–±–Ω–æ–≤–ª–µ–Ω–∏–µ
        updateProgress();
      }

      function stopProgressAnimation() {
        if (progressAnimationId) {
          cancelAnimationFrame(progressAnimationId);
          progressAnimationId = null;
        }
      }

      // –ü–æ–∫–∞–∑–∞—Ç—å –ø–∞–Ω–µ–ª—å —Ä–µ–∞–∫—Ü–∏–π
      function showReactions() {
        reactionsVisible = true;
        reactionsPanel.style.display = "flex";
        overlay.style.display = "block";

        // –°–æ—Ö—Ä–∞–Ω—è–µ–º —Å–æ—Å—Ç–æ—è–Ω–∏–µ –≤–æ—Å–ø—Ä–æ–∏–∑–≤–µ–¥–µ–Ω–∏—è –∏ –ø–∞—É–∑–∏—Ä—É–µ–º –≤–∏–¥–µ–æ
        const currentVideo = stories[currentStoryIndex].video;
        wasPlayingBeforeReactions = isPlaying;
        if (isPlaying) {
          currentVideo.pause();
          stopProgressAnimation();
          isPlaying = false;
        }

        updateStopScreen();
      }

      // –°–∫—Ä—ã—Ç—å –ø–∞–Ω–µ–ª—å —Ä–µ–∞–∫—Ü–∏–π
      function hideReactions() {
        reactionsVisible = false;
        reactionsPanel.style.display = "none";
        overlay.style.display = "none";

        // –í–æ–∑–æ–±–Ω–æ–≤–ª—è–µ–º –≤–æ—Å–ø—Ä–æ–∏–∑–≤–µ–¥–µ–Ω–∏–µ —Ç–æ–ª—å–∫–æ –µ—Å–ª–∏ –æ–Ω–æ –±—ã–ª–æ –∑–∞–ø—É—â–µ–Ω–æ –¥–æ –æ—Ç–∫—Ä—ã—Ç–∏—è —Ä–µ–∞–∫—Ü–∏–π
        const currentVideo = stories[currentStoryIndex].video;
        if (wasPlayingBeforeReactions && currentStoryIndex < stories.length) {
          currentVideo.muted = false;
          currentVideo
            .play()
            .then(() => {
              isPlaying = true;
              updateStopScreen();
              startProgressAnimation();
            })
            .catch((err) => {
              console.error("Error resuming video after reactions:", err);
            });
        }

        updateStopScreen();
      }

      // –û–±—Ä–∞–±–æ—Ç–∫–∞ —Å–≤–∞–π–ø–æ–≤
      function handleTouchStart(e) {
        // –ù–µ –æ–±—Ä–∞–±–∞—Ç—ã–≤–∞–µ–º —Å–≤–∞–π–ø—ã, –µ—Å–ª–∏ –æ—Ç–∫—Ä—ã—Ç–∞ –ø–∞–Ω–µ–ª—å —Ä–µ–∞–∫—Ü–∏–π
        if (reactionsVisible) {
          return;
        }

        // –ù–µ –æ–±—Ä–∞–±–∞—Ç—ã–≤–∞–µ–º —Å–≤–∞–π–ø—ã –Ω–∞ —ç–ª–µ–º–µ–Ω—Ç–∞—Ö —É–ø—Ä–∞–≤–ª–µ–Ω–∏—è
        const target = e.target;
        if (
          target.closest(".show-reactions-btn") ||
          target.closest(".reactions") ||
          target.closest(".controls") ||
          target.closest(".reaction") ||
          target.closest(".stop-screen")
        ) {
          return;
        }

        const touch = e.touches[0];
        touchStartX = touch.clientX;
        touchStartY = touch.clientY;
        isSwipeActive = true;
      }

      function handleTouchMove(e) {
        if (!isSwipeActive) return;

        const touch = e.touches[0];
        const deltaX = touch.clientX - touchStartX;
        const deltaY = touch.clientY - touchStartY;

        // –ü—Ä–µ–¥–æ—Ç–≤—Ä–∞—â–∞–µ–º —Å–∫—Ä–æ–ª–ª —Å—Ç—Ä–∞–Ω–∏—Ü—ã –ø—Ä–∏ –≥–æ—Ä–∏–∑–æ–Ω—Ç–∞–ª—å–Ω–æ–º —Å–≤–∞–π–ø–µ
        if (Math.abs(deltaX) > 10) {
          e.preventDefault();
        }

        // –ü—Ä–æ–≤–µ—Ä—è–µ–º, —á—Ç–æ —ç—Ç–æ –≥–æ—Ä–∏–∑–æ–Ω—Ç–∞–ª—å–Ω—ã–π —Å–≤–∞–π–ø
        if (Math.abs(deltaY) > SWIPE_VERTICAL_THRESHOLD) {
          return;
        }

        // –û–ø—Ä–µ–¥–µ–ª—è–µ–º –Ω–∞–ø—Ä–∞–≤–ª–µ–Ω–∏–µ —Å–≤–∞–π–ø–∞
        if (Math.abs(deltaX) > 10) {
          isSwiping = true;
          swipeDirection = deltaX > 0 ? "right" : "left";

          // –ü–æ–∫–∞–∑—ã–≤–∞–µ–º –≤–∏–∑—É–∞–ª—å–Ω—É—é –æ–±—Ä–∞—Ç–Ω—É—é —Å–≤—è–∑—å –≤–æ –≤—Ä–µ–º—è —Å–≤–∞–π–ø–∞
          const containerWidth = slider.offsetWidth || 450;
          const progress = Math.min(Math.abs(deltaX) / containerWidth, 1);
          const offsetX = deltaX * 0.5; // –£–º–µ–Ω—å—à–∞–µ–º —Å–º–µ—â–µ–Ω–∏–µ –¥–ª—è –±–æ–ª–µ–µ –ø–ª–∞–≤–Ω–æ–≥–æ —ç—Ñ—Ñ–µ–∫—Ç–∞

          // –î–æ–±–∞–≤–ª—è–µ–º –∫–ª–∞—Å—Å swiping –¥–ª—è –æ—Ç–∫–ª—é—á–µ–Ω–∏—è transition –≤–æ –≤—Ä–µ–º—è –¥–≤–∏–∂–µ–Ω–∏—è
          stories.forEach((story) => {
            story.element.classList.add("swiping");
          });

          // –û–±–Ω–æ–≤–ª—è–µ–º –ø–æ–∑–∏—Ü–∏–∏ —Å–ª–∞–π–¥–æ–≤ –≤–æ –≤—Ä–µ–º—è —Å–≤–∞–π–ø–∞
          if (swipeDirection === "left" && currentStoryIndex < stories.length - 1) {
            // –°–≤–∞–π–ø –≤–ª–µ–≤–æ - –ø–æ–∫–∞–∑—ã–≤–∞–µ–º —Å–ª–µ–¥—É—é—â–∏–π —Å–ª–∞–π–¥ —Å–ø—Ä–∞–≤–∞
            showStory(currentStoryIndex, offsetX);
            const nextStory = stories[currentStoryIndex + 1];
            if (nextStory) {
              nextStory.element.style.display = "flex";
              const nextOffset = containerWidth + offsetX;
              nextStory.element.style.transform = `translateX(${nextOffset}px)`;
            }
          } else if (swipeDirection === "right" && currentStoryIndex > 0) {
            // –°–≤–∞–π–ø –≤–ø—Ä–∞–≤–æ - –ø–æ–∫–∞–∑—ã–≤–∞–µ–º –ø—Ä–µ–¥—ã–¥—É—â–∏–π —Å–ª–∞–π–¥ —Å–ª–µ–≤–∞
            showStory(currentStoryIndex, offsetX);
            const prevStory = stories[currentStoryIndex - 1];
            if (prevStory) {
              prevStory.element.style.display = "flex";
              const prevOffset = -containerWidth + offsetX;
              prevStory.element.style.transform = `translateX(${prevOffset}px)`;
            }
          }
        }
      }

      function handleTouchEnd(e) {
        // –ù–µ –æ–±—Ä–∞–±–∞—Ç—ã–≤–∞–µ–º —Å–≤–∞–π–ø—ã, –µ—Å–ª–∏ –æ—Ç–∫—Ä—ã—Ç–∞ –ø–∞–Ω–µ–ª—å —Ä–µ–∞–∫—Ü–∏–π
        if (reactionsVisible) {
          return;
        }

        // –ù–µ –æ–±—Ä–∞–±–∞—Ç—ã–≤–∞–µ–º —Å–≤–∞–π–ø—ã –Ω–∞ —ç–ª–µ–º–µ–Ω—Ç–∞—Ö —É–ø—Ä–∞–≤–ª–µ–Ω–∏—è
        const target = e.target;
        if (
          target.closest(".show-reactions-btn") ||
          target.closest(".reactions") ||
          target.closest(".controls") ||
          target.closest(".reaction") ||
          target.closest(".stop-screen")
        ) {
          return;
        }

        // –ü—Ä–æ–≤–µ—Ä—è–µ–º, —á—Ç–æ —Å–≤–∞–π–ø –±—ã–ª –Ω–∞—á–∞—Ç
        if (!isSwipeActive) {
          return;
        }

        const touch = e.changedTouches[0];
        touchEndX = touch.clientX;
        touchEndY = touch.clientY;

        const deltaX = touchEndX - touchStartX;
        const deltaY = touchEndY - touchStartY;

        // –ü—Ä–æ–≤–µ—Ä—è–µ–º, —á—Ç–æ —ç—Ç–æ –≥–æ—Ä–∏–∑–æ–Ω—Ç–∞–ª—å–Ω—ã–π —Å–≤–∞–π–ø (–Ω–µ –≤–µ—Ä—Ç–∏–∫–∞–ª—å–Ω—ã–π)
        if (Math.abs(deltaY) > SWIPE_VERTICAL_THRESHOLD) {
          // –°–±—Ä–∞—Å—ã–≤–∞–µ–º —Å–æ—Å—Ç–æ—è–Ω–∏–µ
          isSwipeActive = false;
          return; // –í–µ—Ä—Ç–∏–∫–∞–ª—å–Ω—ã–π —Å–≤–∞–π–ø - –∏–≥–Ω–æ—Ä–∏—Ä—É–µ–º
        }

        // –ü—Ä–æ–≤–µ—Ä—è–µ–º –º–∏–Ω–∏–º–∞–ª—å–Ω–æ–µ —Ä–∞—Å—Å—Ç–æ—è–Ω–∏–µ –¥–ª—è —Å–≤–∞–π–ø–∞
        if (Math.abs(deltaX) < SWIPE_THRESHOLD) {
          // –°–ª–∏—à–∫–æ–º –∫–æ—Ä–æ—Ç–∫–∏–π —Å–≤–∞–π–ø - –≤–æ–∑–≤—Ä–∞—â–∞–µ–º—Å—è –∫ —Ç–µ–∫—É—â–µ–º—É —Å–ª–∞–π–¥—É
          if (isSwiping) {
            resetStoryPositions();
            isSwiping = false;
          }
          isSwipeActive = false;
          swipeDirection = null;
          return;
        }

        // –û–ø—Ä–µ–¥–µ–ª—è–µ–º –Ω–∞–ø—Ä–∞–≤–ª–µ–Ω–∏–µ —Å–≤–∞–π–ø–∞ –∏ –ø–µ—Ä–µ–∫–ª—é—á–∞–µ–º—Å—è
        const containerWidth = slider.offsetWidth || 450;
        const swipeProgress = Math.abs(deltaX) / containerWidth;

        // –ï—Å–ª–∏ —Å–≤–∞–π–ø –±—ã–ª –¥–æ—Å—Ç–∞—Ç–æ—á–Ω–æ –¥–ª–∏–Ω–Ω—ã–º (–±–æ–ª—å—à–µ 30% —à–∏—Ä–∏–Ω—ã), –ø–µ—Ä–µ–∫–ª—é—á–∞–µ–º—Å—è
        if (swipeProgress > 0.3 || Math.abs(deltaX) > SWIPE_THRESHOLD) {
          // –£–±–∏—Ä–∞–µ–º –∫–ª–∞—Å—Å swiping –¥–ª—è –≤–∫–ª—é—á–µ–Ω–∏—è –ø–ª–∞–≤–Ω–æ–π –∞–Ω–∏–º–∞—Ü–∏–∏
          stories.forEach((story) => {
            story.element.classList.remove("swiping");
          });

          if (deltaX > 0) {
            // –°–≤–∞–π–ø –≤–ø—Ä–∞–≤–æ - –ø—Ä–µ–¥—ã–¥—É—â–∏–π —Å–ª–∞–π–¥
            if (currentStoryIndex > 0) {
              prev();
            } else {
              resetStoryPositions();
            }
          } else {
            // –°–≤–∞–π–ø –≤–ª–µ–≤–æ - —Å–ª–µ–¥—É—é—â–∏–π —Å–ª–∞–π–¥
            if (currentStoryIndex < stories.length - 1) {
              next();
            } else {
              resetStoryPositions();
            }
          }
        } else {
          // –°–≤–∞–π–ø –±—ã–ª –Ω–µ–¥–æ—Å—Ç–∞—Ç–æ—á–Ω–æ –¥–ª–∏–Ω–Ω—ã–º - –≤–æ–∑–≤—Ä–∞—â–∞–µ–º—Å—è –∫ —Ç–µ–∫—É—â–µ–º—É —Å–ª–∞–π–¥—É
          resetStoryPositions();
        }

        // –°–±—Ä–∞—Å—ã–≤–∞–µ–º —Å–æ—Å—Ç–æ—è–Ω–∏–µ –ø–æ—Å–ª–µ –æ–±—Ä–∞–±–æ—Ç–∫–∏ —Å–≤–∞–π–ø–∞
        isSwipeActive = false;
        isSwiping = false;
        swipeDirection = null;
      }

      // –û–±—Ä–∞–±–æ—Ç–∫–∞ –∫–ª–∏–∫–∞ –ø–æ —Ä–µ–∞–∫—Ü–∏–∏
      function handleReactionClick(reaction) {
        const currentStory = stories[currentStoryIndex];
        const storyElement = currentStory.element;

        // –°–æ–∑–¥–∞–µ–º –ª–µ—Ç—è—â—É—é —Ä–µ–∞–∫—Ü–∏—é
        const flyingReaction = document.createElement("div");
        flyingReaction.className = "flying-reaction";
        flyingReaction.textContent = reaction;
        flyingReaction.style.left = `${Math.random() * 80 + 10}%`;
        storyElement.appendChild(flyingReaction);

        // –£–¥–∞–ª—è–µ–º –ø–æ—Å–ª–µ –∞–Ω–∏–º–∞—Ü–∏–∏
        setTimeout(() => {
          flyingReaction.remove();
        }, 500);

        // –ó–∞–∫—Ä—ã–≤–∞–µ–º –ø–∞–Ω–µ–ª—å —Ä–µ–∞–∫—Ü–∏–π
        hideReactions();
      }

      // –û–±—Ä–∞–±–æ—Ç—á–∏–∫–∏ —Å–æ–±—ã—Ç–∏–π
      showReactionsBtn.addEventListener("click", (e) => {
        e.stopPropagation();
        showReactions();
      });

      overlay.addEventListener("click", (e) => {
        e.stopPropagation();
        hideReactions();
      });

      reactionButtons.forEach((button) => {
        button.addEventListener("click", (e) => {
          e.stopPropagation();
          handleReactionClick(button.textContent);
        });
      });

      // –ò–Ω–∏—Ü–∏–∞–ª–∏–∑–∞—Ü–∏—è –ø—Ä–∏ –∑–∞–≥—Ä—É–∑–∫–µ —Å—Ç—Ä–∞–Ω–∏—Ü—ã
      document.addEventListener("DOMContentLoaded", () => {
        // –°–∫—Ä—ã–≤–∞–µ–º –ø–∞–Ω–µ–ª—å —Ä–µ–∞–∫—Ü–∏–π –∏ overlay –∏–∑–Ω–∞—á–∞–ª—å–Ω–æ
        reactionsPanel.style.display = "none";
        overlay.style.display = "none";
        // –ò–∑–Ω–∞—á–∞–ª—å–Ω–æ —Å–∫—Ä—ã–≤–∞–µ–º —ç–∫—Ä–∞–Ω –ø–∞—É–∑—ã, —Ç–∞–∫ –∫–∞–∫ –≤–∏–¥–µ–æ –±—É–¥–µ—Ç –∏–≥—Ä–∞—Ç—å –∞–≤—Ç–æ–º–∞—Ç–∏—á–µ—Å–∫–∏
        stopScreen.classList.add("stop-screen_playing");

        // –û–±—Ä–∞–±–æ—Ç—á–∏–∫ –∫–ª–∏–∫–∞ –ø–æ —ç–∫—Ä–∞–Ω—É –ø–∞—É–∑—ã –¥–ª—è –≤–æ–∑–æ–±–Ω–æ–≤–ª–µ–Ω–∏—è –≤–æ—Å–ø—Ä–æ–∏–∑–≤–µ–¥–µ–Ω–∏—è
        stopScreen.addEventListener("click", (e) => {
          e.stopPropagation();
          // –ù–µ –æ–±—Ä–∞–±–∞—Ç—ã–≤–∞–µ–º –∫–ª–∏–∫–∏, –µ—Å–ª–∏ –æ—Ç–∫—Ä—ã—Ç–∞ –ø–∞–Ω–µ–ª—å —Ä–µ–∞–∫—Ü–∏–π
          if (!reactionsVisible) {
            togglePlay();
          }
        });

        // –û–±—Ä–∞–±–æ—Ç—á–∏–∫ –∫–ª–∏–∫–∞ –ø–æ –æ–±–ª–∞—Å—Ç–∏ —Å—Ç–æ—Ä–∏–∑ –¥–ª—è –ø–∞—É–∑—ã/–≤–æ—Å–ø—Ä–æ–∏–∑–≤–µ–¥–µ–Ω–∏—è
        slider.addEventListener("click", (e) => {
          // –ù–µ –æ–±—Ä–∞–±–∞—Ç—ã–≤–∞–µ–º –∫–ª–∏–∫–∏ –ø–æ –∫–Ω–æ–ø–∫–∞–º –∏ —Ä–µ–∞–∫—Ü–∏—è–º
          if (
            e.target.closest(".show-reactions-btn") ||
            e.target.closest(".reactions") ||
            e.target.closest(".controls") ||
            e.target.closest(".reaction") ||
            e.target.closest(".stop-screen") ||
            e.target.closest(".stories__video")
          ) {
            return;
          }
          // –û–±—Ä–∞–±–∞—Ç—ã–≤–∞–µ–º –∫–ª–∏–∫–∏ –ø–æ –æ–±–ª–∞—Å—Ç–∏ —Å—Ç–æ—Ä–∏–∑ (–Ω–æ –Ω–µ –ø–æ —Å–∞–º–æ–º—É –≤–∏–¥–µ–æ, —Ç.–∫. —É –≤–∏–¥–µ–æ —Å–≤–æ–π –æ–±—Ä–∞–±–æ—Ç—á–∏–∫)
          if (
            e.target.classList.contains("stories__story") ||
            e.target === slider
          ) {
            togglePlay();
          }
        });

        initStories();

        // –ò–Ω–∏—Ü–∏–∞–ª–∏–∑–∏—Ä—É–µ–º —Å–æ—Å—Ç–æ—è–Ω–∏–µ –∫–æ–Ω—Ç—Ä–æ–ª–æ–≤ –ø–æ—Å–ª–µ –∑–∞–≥—Ä—É–∑–∫–∏ —Å—Ç–æ—Ä–∏–∑
        setTimeout(() => {
          updateControlsState();
        }, 100);

        // –û–±—Ä–∞–±–æ—Ç—á–∏–∫–∏ touch-—Å–æ–±—ã—Ç–∏–π –¥–ª—è —Å–≤–∞–π–ø–æ–≤ –Ω–∞ –∫–æ–Ω—Ç–µ–π–Ω–µ—Ä–µ —Å—Ç–æ—Ä–∏–∑
        slider.addEventListener("touchstart", handleTouchStart, {
          passive: false,
        });
        slider.addEventListener("touchmove", handleTouchMove, {
          passive: false,
        });
        slider.addEventListener("touchend", handleTouchEnd, {
          passive: true,
        });
        slider.addEventListener("touchcancel", () => {
          if (isSwiping) {
            resetStoryPositions();
            isSwiping = false;
          }
          isSwipeActive = false;
          swipeDirection = null;
        });

        // –ü–æ–¥–¥–µ—Ä–∂–∫–∞ –∫–ª–∞–≤–∏–∞—Ç—É—Ä–Ω—ã—Ö —Å–æ–∫—Ä–∞—â–µ–Ω–∏–π
        document.addEventListener("keydown", (e) => {
          // –ü—Ä–µ–¥–æ—Ç–≤—Ä–∞—â–∞–µ–º –æ–±—Ä–∞–±–æ—Ç–∫—É, –µ—Å–ª–∏ –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—å –≤–≤–æ–¥–∏—Ç —Ç–µ–∫—Å—Ç
          if (
            e.target.tagName === "INPUT" ||
            e.target.tagName === "TEXTAREA" ||
            e.target.isContentEditable
          ) {
            return;
          }

          switch (e.key) {
            case "ArrowLeft":
              e.preventDefault();
              prev();
              break;
            case "ArrowRight":
              e.preventDefault();
              next();
              break;
            case " ":
            case "Spacebar":
              e.preventDefault();
              togglePlay();
              break;
            case "r":
            case "R":
              e.preventDefault();
              if (!reactionsVisible) {
                showReactions();
              }
              break;
            case "Escape":
              e.preventDefault();
              if (reactionsVisible) {
                hideReactions();
              }
              break;
          }
        });
      });

      // –ì–ª–æ–±–∞–ª—å–Ω—ã–µ —Ñ—É–Ω–∫—Ü–∏–∏ –¥–ª—è –≤—ã–∑–æ–≤–∞ –∏–∑ HTML
      window.togglePlay = togglePlay;
      window.next = next;
      window.prev = prev;
    </script>
  </body>
</html>
